<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebPongJS :: sockJS proof of concept</title>

    <!-- Library includes -->
    <script src="http://cdn.sockjs.org/sockjs-0.3.min.js"></script>
    <script src="http://jashkenas.github.com/coffee-script/extras/coffee-script.js"></script>

    <!-- WebPongJS includes -->
    <script src="../common/game.js"></script>
    <script src="../common/config.js"></script>

    <script type="text/coffeescript">
      Game = window.WebPongJSGame

      class Client

        constructor: (@conf) ->
          @game = new Game
          @sock = new SockJS "http://#{@conf.server.addr}:#{@conf.server.port}#{@conf.server.prefix}"

        start: ->
          @sock.onmessage = (e) =>
            drift = Math.abs(Number(e.data) - (new Date).getTime())
            console.log '[message]', drift
            if drift > @conf.update.maxDrift
              console.log 'Want update'
              @sock.send 'update'

          @sock.onopen = =>
            @game.start()
            console.log 'Connected, sending hi'
            @sock.send 'Hi, dude!'
            @sock.send 'Hi again, dude!'

          @sock.onclose = =>
            console.log 'Connection closed'
            @game.stop()

      conf = window.WebPongJSConfig
      client = new Client conf
      client.start()
    </script>
  </head>

  <body>
    <canvas id="board" width="1900" height="1000">
    Your browser needs to support canvas for this to work!
    </canvas>
  </body>
</html>
